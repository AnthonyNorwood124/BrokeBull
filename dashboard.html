<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>BrokeBull — Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Your site styles -->
  <link rel="stylesheet" href="style.css" />

  <!-- Firebase (Compat for static hosting) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <!-- Must come AFTER the SDKs -->
  <script src="firebase.js"></script>
</head>
<body>
  <header class="hero">
    <img class="logo" src="images/logo.jpg" alt="BrokeBull" />
    <h1>Welcome to BrokeBull</h1>
    <div>
      <button onclick="logout()">Logout</button>
    </div>
  </header>

  <!-- Simple loading placeholder while auth session restores -->
  <div id="loading" style="color:#bbb;text-align:center;margin:24px 0;">Loading…</div>

  <!-- PRO: hidden by default; shown when users/{uid}.role === 'pro' -->
  <section id="proContent" style="display:none;">
    <h2>Pro Dashboard</h2>
    <ul>
      <li>Full Stage-2 Watchlist</li>
      <li>Daily Market Insights</li>
      <li>Weekly Pro Newsletter</li>
    </ul>
    <!-- Add your Pro modules here -->
  </section>

  <!-- BASIC: hidden by default; shown when role !== 'pro' -->
  <section id="basicContent" style="display:none;">
    <h2>Basic Access</h2>
    <p>You're in preview mode. Upgrade to unlock the full Pro experience.</p>
    <button class="btn" onclick="upgradePro()">Join Pro ($19/mo)</button>
  </section>

  <script>
    // IMPORTANT:
    // Do NOT use auth.currentUser synchronously.
    // Wait for onAuthStateChanged, then fetch role and paint UI.

    document.addEventListener('DOMContentLoaded', () => {
      const auth = firebase.auth();         // use the initialized app
      const db   = firebase.firestore();

      const loading = document.getElementById('loading');
      const proEl   = document.getElementById('proContent');
      const basicEl = document.getElementById('basicContent');

      auth.onAuthStateChanged(async (user) => {
        if (!user) {
          // Not signed in -> send to login
          window.location.replace('login.html');
          return;
        }

        try {
          const snap = await db.collection('users').doc(user.uid).get();
          const role = snap.exists && snap.data().role ? snap.data().role : 'basic';

          if (loading) loading.style.display = 'none';

          if (role === 'pro') {
            if (proEl)   proEl.style.display   = 'block';
            if (basicEl) basicEl.style.display = 'none';
          } else {
            if (proEl)   proEl.style.display   = 'none';
            if (basicEl) basicEl.style.display = 'block';
          }
        } catch (err) {
          console.error('Role fetch failed:', err);
          if (loading) loading.style.display = 'none';
          // Fallback: show Basic
          if (proEl)   proEl.style.display   = 'none';
          if (basicEl) basicEl.style.display = 'block';
        }
      });
    });
  </script>
</body>
</html>
